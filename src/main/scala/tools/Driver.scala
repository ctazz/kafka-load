package tools

import com.typesafe.config.{Config, ConfigFactory}
import kafka.serializer.{StringDecoder, Decoder}
import org.apache.kafka.clients.producer.ProducerRecord
import tools.Window.{WindowStatsWithEndTime, ProcessStatsWithCurrTime}

import scala.collection.Iterator


object Driver extends App {

  val initialConfig = ConfigFactory.load
  val consume = initialConfig.getBoolean("read")
  val outputPrefix = if(consume) "Read: " else "Write: "

  def sendFunc(data: Tuple2[ProcessStatsWithCurrTime, WindowStatsWithEndTime]): Unit = {
    println(outputPrefix + Window.defaultDump(data))
  }

  if(consume) {
    new ConsumerExperiment[String, String] {
      override lazy val config = initialConfig.getConfig("consumer")
      override val keyDecoder: Decoder[String] = new StringDecoder()
      override val valueDecoder: Decoder[String] = new StringDecoder()
      def sendOutput(data: Tuple2[ProcessStatsWithCurrTime, WindowStatsWithEndTime]): Unit = sendFunc(data)
    }
  }
  else {

    val sendMessagesAsSingleRecord = initialConfig.getBoolean("producer.send.messages.as.single.record ")

    val eventsAsOneMessage = """
[    {        "ingest": {            "time": "2017-01-09T22:36:26.8210000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:18.2050438Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.Received.[081466849].[RBTW]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:18.3631594Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "loadPlanId": "9807A228-2C85-4775-9A0E-2CE06758BE90"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:27.3453679Z",        "PartitionId": 0,        "EventEnqueuedUtcTime": "2017-01-09T22:36:27.0970000Z"    },
    {        "ingest": {            "time": "2017-01-09T22:36:26.8210000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:23.2423824Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.FuncAck.Send997ToPartner.[081466849].[RBTW]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:23.4023703Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:27.3453679Z",        "PartitionId": 0,        "EventEnqueuedUtcTime": "2017-01-09T22:36:27.0970000Z"    },
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:28.2636814Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.FuncAck.PosMDNFromPartner.[081466849].[RBTW]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:28.4230680Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    },
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:33.3028837Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.SentToPartner.[081466849].[CMCMSFT]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:33.4633823Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1",                    "loadPlanId": "9807A228-2C85-4775-9A0E-2CE06758BE90"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    },
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:38.3474414Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "AppAction": "LoadPlan.TechAck.PosMDNFromPartner.[081466849].[CMCMSFT]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:38.5066948Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1",                    "loadPlanId": "9807A228-2C85-4775-9A0E-2CE06758BE90"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    },
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:43.4897196Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "AppAction": "LoadPlan.FuncAck.Pos997FromPartner.[081466849].[CMCMSFT]",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:43.6503266Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    }]
                         """

    val eventsAsSeveralMessages =
      """
    {        "ingest": {            "time": "2017-01-09T22:36:26.8210000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:18.2050438Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.Received.[081466849].[RBTW]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:18.3631594Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "loadPlanId": "9807A228-2C85-4775-9A0E-2CE06758BE90"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:27.3453679Z",        "PartitionId": 0,        "EventEnqueuedUtcTime": "2017-01-09T22:36:27.0970000Z"    }
    {        "ingest": {            "time": "2017-01-09T22:36:26.8210000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:23.2423824Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.FuncAck.Send997ToPartner.[081466849].[RBTW]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:23.4023703Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:27.3453679Z",        "PartitionId": 0,        "EventEnqueuedUtcTime": "2017-01-09T22:36:27.0970000Z"    }
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:28.2636814Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.FuncAck.PosMDNFromPartner.[081466849].[RBTW]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:28.4230680Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    }
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:33.3028837Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "deliveryOrderId": "8014261842",                    "AppAction": "LoadPlan.SentToPartner.[081466849].[CMCMSFT]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:33.4633823Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "parentDONumber": "212942814",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1",                    "loadPlanId": "9807A228-2C85-4775-9A0E-2CE06758BE90"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    },
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:38.3474414Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "AppAction": "LoadPlan.TechAck.PosMDNFromPartner.[081466849].[CMCMSFT]",                    "countryCode": "USA",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:38.5066948Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1",                    "loadPlanId": "9807A228-2C85-4775-9A0E-2CE06758BE90"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    }
    {        "ingest": {            "time": "2017-01-09T22:36:57.0240000Z",            "clientIp": "13.66.226.137",            "quality": 24736        },        "name": "Microsoft.ApplicationInsights.Dev.aif5b364b0890bb4793940f4e05f5ccdb75.Event",        "time": "2017-01-09T22:36:43.4897196Z",        "iKey": "AIF-5b364b08-90bb-4793-940f-4e05f5ccdb75",        "tags": {            "ai.internal.sdkVersion": "dotnet: 2.1.0.26048"        },        "data": {            "baseType": "EventData",            "baseData": {                "ver": 2,                "name": "LoadPlan",                "properties": {                    "MsitPartB": "true",                    "DeveloperMode": "true",                    "AppAction": "LoadPlan.FuncAck.Pos997FromPartner.[081466849].[CMCMSFT]",                    "applicationName": "DTVIntegration",                    "EventOccurrenceTime": "2017-01-09T22:36:43.6503266Z",                    "EventType": "BusinessProcessEvent",                    "UserRoleName": "MININT-EGTRAM3.fareast.corp.microsoft.com",                    "processName": "Process204",                    "XCV": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "CorrelationId": "2b14133e-76d1-41f6-bed6-2e89c8345532",                    "PartnerId": "RBTW",                    "btsMessageType": "http://schemas.microsoft.com/BizTalk/EDI/X12/2006#X12_00401_204",                    "environment": "UAT",                    "controlNumber": "1388726",                    "stageName": "ReceivedEDI204Message",                    "TemplateType": "Internal.BusinessProcessEvent",                    "taskId": "204",                    "transactionId": "6E0FE8A7-EF0B-40F5-AF36-2BD6742B0BAC",                    "sequenceNumber": "1",                    "plantCode": "4260",                    "eventSource": "MS.SupplyChain.SupplyChainEvent",                    "BusinessProcessName": "LoadPlan",                    "ComponentType": "BackgroundProcess",                    "TestBenchProcess": "1",                    "SenderID": "081466849",                    "hub": "DEV Extranet",                    "UniqueTestKey": "P139-T15312",                    "creationDateTime": "2016-11-03 18:29:10.483",                    "etwTraceId": "11e02376-00ce-420e-9e49-fbde698e2490",                    "entityId": "212942814",                    "vendorNumber": "RBTW",                    "vortextransmissionuri": "https://vortex.data.microsoft.com/collect/v1"                }            }        },        "EventProcessedUtcTime": "2017-01-09T22:36:57.3819566Z",        "PartitionId": 2,        "EventEnqueuedUtcTime": "2017-01-09T22:36:56.8660000Z"    }"""

    val arrayOfMessages = eventsAsSeveralMessages.split("\n").filterNot(_.trim == "")


    new WriteToKafka[String, String] {
      override lazy val config: Config = initialConfig.getConfig("producer")
      lazy val topicName = config.getString("topicName")

      def sendOutput(data: Tuple2[ProcessStatsWithCurrTime, WindowStatsWithEndTime]): Unit = sendFunc(data)



      def maybeIntToJavaInteger(maybeN: Option[Int]): java.lang.Integer = {
          maybeN match {
            case Some(n) => n
            case None => null
          }
      }

      def recordIterator(maybePartitionInWhichToWrite: Option[Int]): Iterator[ProducerRecord[String, String]] = {
        println(s"creating  a new recordIterator for maybePartition $maybePartitionInWhichToWrite ")
        if (sendMessagesAsSingleRecord) {
          new scala.Iterator[ProducerRecord[String, String]] {
            override def next(): ProducerRecord[String, String] = {
              new ProducerRecord[String, String](topicName,
                maybeIntToJavaInteger(maybePartitionInWhichToWrite),
                null,
                eventsAsOneMessage)
            }

            override def hasNext: Boolean = true
          }
        }
        else {
          new scala.Iterator[ProducerRecord[String, String]] {
            var counter: Long = 0

            override def next(): ProducerRecord[String, String] = {
              val cnt = counter
              //println(s"counter is ${cnt} and maybePartition is $maybePartitionInWhichToWrite")
              val nextMessage = arrayOfMessages((cnt % arrayOfMessages.size).toInt)
              //println(s"nextMessage is $nextMessage")

              val returnMe = new ProducerRecord[String, String](topicName,
                maybeIntToJavaInteger(maybePartitionInWhichToWrite),
                null,
                nextMessage
              )
              counter = counter + 1
              returnMe
            }

            override def hasNext: Boolean = true
          }

        }


      }

    }
  }






}
